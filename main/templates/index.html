<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Classical RAG</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    /* [unchanged styles] */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #1a1a1a;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1, h2 {
      color: #4CAF50;
      font-weight: 300;
      width: 100%;
      max-width: 900px;
      text-align: center;
    }
    h2 {
      margin-top: 40px;
      font-size: 1.2em;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    #query-form {
      display: flex;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    #query-input {
      flex-grow: 1;
      padding: 12px 15px;
      border: 1px solid #444;
      border-radius: 20px 0 0 20px;
      background-color: #2a2a2a;
      color: #f0f0f0;
      font-size: 16px;
      outline: none;
    }
    #submit-btn {
      padding: 12px 20px;
      border: none;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      cursor: pointer;
      border-radius: 0 20px 20px 0;
    }
    #docs-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .doc-card {
      background-color: #282828;
      border: 1px solid #333;
      border-left: 4px solid #4CAF50;
      padding: 15px;
      border-radius: 5px;
    }
    .doc-card-header {
      font-weight: bold;
      color: #ccc;
      margin-bottom: 10px;
    }
    .doc-card-content {
      font-size: 0.9em;
      color: #bbb;
      line-height: 1.5;
    }
    #graph-container {
      width: 100%;
      max-width: 900px;
      height: 500px;
      border: 1px solid #333;
      border-radius: 8px;
      background-color: #222;
      margin-top: 20px;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #legend {
      max-width: 900px;
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      font-size: 0.9em;
      color: #ccc;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      display: inline-block;
    }
  </style>
</head>
<body>

<h1>Classical RAG System</h1>

<form id="query-form">
  <input type="text" id="query-input" placeholder="Ask about your documents..." autocomplete="off">
  <button type="submit" id="submit-btn">Generate</button>
</form>

<div class="loader" id="loader"></div>
<div id="answer-container" style="width: 100%; max-width: 900px; margin-bottom: 30px; display:none;">
  <h2>Answer</h2>
  <div id="answer-text" style="line-height:1.6; color: #ddd; font-size: 1.05em;"></div>
</div>
<div id="docs-container"></div>

<div id="graph-section" style="display:none; width: 100%; max-width: 900px;">
  <h2>Knowledge Graph</h2>
  <div id="graph-container"></div>
  <div id="legend">
    <div class="legend-item"><span class="legend-color" style="background:#FF6347"></span> Document</div>
    <div class="legend-item"><span class="legend-color" style="background:#6495ED"></span> Person</div>
    <div class="legend-item"><span class="legend-color" style="background:#3CB371"></span> Organization</div>
    <div class="legend-item"><span class="legend-color" style="background:#FFD700"></span> Location</div>
    <div class="legend-item"><span class="legend-color" style="background:#9370DB"></span> Concept</div>
    <div class="legend-item"><span class="legend-color" style="background:#48D1CC"></span> Technology</div>
  </div>
</div>

<script>
  const form = document.getElementById('query-form');
  const input = document.getElementById('query-input');
  const loader = document.getElementById('loader');
  const docsContainer = document.getElementById('docs-container');
  const graphSection = document.getElementById('graph-section');
  const graphContainer = document.getElementById('graph-container');
  let graphSessionId = null;

  window.addEventListener('beforeunload', () => {
    if (graphSessionId) navigator.sendBeacon(`/cleanup/${graphSessionId}`, '');
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const queryText = input.value.trim();
    if (!queryText) return;
    if (graphSessionId) {
        try {
            await fetch(`/cleanup/${graphSessionId}`, { method: 'POST' });
        } catch (cleanupErr) {
            console.warn('Cleanup failed:', cleanupErr);
        }
        graphSessionId = null;
    }
    loader.style.display = 'block';
    document.getElementById("answer-container").style.display = 'none';
    document.getElementById("answer-text").innerHTML = '';
    docsContainer.innerHTML = '';
    graphSection.style.display = 'none';
    graphContainer.innerHTML = '';

    try {
      const response = await fetch('/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: queryText })
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || `HTTP error! Status: ${response.status}`);
      }

      const data = await response.json();
      if (data.answer) {
        const answerContainer = document.getElementById("answer-container");
        const answerText = document.getElementById("answer-text");
        answerText.innerText = data.answer.trim();
        answerContainer.style.display = 'block';
      }
      graphSessionId = data.session_id;

      if (data.retrieved_docs?.length > 0) {
        docsContainer.innerHTML = '<h2>Retrieved Documents</h2>';
        data.retrieved_docs.forEach(doc => {
          const card = document.createElement('div');
          card.className = 'doc-card';
          card.innerHTML = `
              <div class="doc-card-header">Similarity Score: ${doc.score}</div>
              <div class="doc-card-content">${doc.content_snippet}</div>
          `;
          docsContainer.appendChild(card);
        });
      } else {
        docsContainer.innerHTML = '<h2>No relevant documents found for this query.</h2>';
      }

      if (data.nodes?.length > 0) {
        graphSection.style.display = 'block';
        renderGraph(data.nodes, data.edges);
      } else if (data.retrieved_docs?.length > 0) {
        graphSection.style.display = 'block';
        graphContainer.innerHTML = '<p style="text-align:center;padding:20px;">Documents were found, but no entities could be extracted to build a graph.</p>';
      }

    } catch (error) {
      console.error('Error:', error);
      docsContainer.innerHTML = `<h2 style="color:#ff6b6b;">Error: ${error.message}</h2>`;
    } finally {
      loader.style.display = 'none';
    }
  });

function renderGraph(rawNodes, rawEdges) {
  const MAX_EDGES_PER_DOC = 6;
  const docNodeIds = new Set(rawNodes.filter(n => n.group === 'document').map(n => n.id));
  const edgeCountPerDoc = {};

  const uniqueEdges = [];
  const edgeMap = new Set();

  rawEdges.forEach(edge => {
    const key = `${edge.from}->${edge.to}->${edge.label}`;
    if (edgeMap.has(key)) return;

    const isFromDoc = docNodeIds.has(edge.from);
    const isToDoc = docNodeIds.has(edge.to);
    const docNode = isFromDoc ? edge.from : isToDoc ? edge.to : null;

    if (docNode) {
      edgeCountPerDoc[docNode] = (edgeCountPerDoc[docNode] || 0) + 1;
      if (edgeCountPerDoc[docNode] > MAX_EDGES_PER_DOC) return;
    }

    uniqueEdges.push({
      ...edge,
      arrows: 'to',
      label: edge.relation || edge.label || '',
      font: { align: 'top' }
    });

    edgeMap.add(key);
  });

  const visibleNodeIds = new Set();
  uniqueEdges.forEach(e => {
    visibleNodeIds.add(e.from);
    visibleNodeIds.add(e.to);
  });

  const visibleNodes = rawNodes.filter(n => visibleNodeIds.has(n.id));

  const graphData = {
    nodes: new vis.DataSet(visibleNodes.map(n => ({ ...n, shape: 'dot', size: 20 }))),
    edges: new vis.DataSet(uniqueEdges)
  };

  const options = {
    nodes: {
      font: { size: 14, color: '#ffffff' },
      borderWidth: 2
    },
    edges: {
      width: 2,
      color: { color: '#848484', highlight: '#4CAF50' },
      smooth: {
        type: 'dynamic'
      }
    },
    physics: {
      forceAtlas2Based: {
        gravitationalConstant: -30,
        centralGravity: 0.01,
        springLength: 200,
        springConstant: 0.04
      },
      solver: 'forceAtlas2Based',
      timestep: 0.4,
      stabilization: { iterations: 150 }
    },
    groups: {
      document: { color: { background: '#FF6347', border: '#FF4500' }, shape: 'dot' },
      Person: { color: { background: '#6495ED', border: '#4169E1' }, shape: 'dot' },
      Organization: { color: { background: '#3CB371', border: '#2E8B57' }, shape: 'dot' },
      Location: { color: { background: '#FFD700', border: '#FFA500' }, shape: 'dot' },
      Concept: { color: { background: '#9370DB', border: '#8A2BE2' }, shape: 'dot' },
      Technology: { color: { background: '#48D1CC', border: '#20B2AA' }, shape: 'dot' }
    }
  };

  new vis.Network(graphContainer, graphData, options);
}

</script>
</body>
</html>
